{% extends "base.html" %}

{% block title %}Login - Rebox Mail{% endblock %}

{% block head %}
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
{% endblock %}

{% block content %}
    <h2>Register</h2>
    <input type="text" id="username" placeholder="Username">
    <button onclick="register()">Register with Passkey</button>
    
    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Username">
    <button onclick="login()">Login with Passkey</button>
</div>
{% endblock %}

{% block scripts %}

    <script>
        import { startRegistration } from '@simplewebauthn/browser';

        async function register() {
            const username = document.getElementById('username').value;
            if (!username) {
                alert('Please enter a username');
                return;
            }

            // Get registration options
            const resp = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            const optionsJSON = await resp.json();

            if (resp.status !== 200) {
                // TODO: Display error message to user
                alert(optionsJSON.error);
                return;
            }

            let attResp;
            try {
                // Pass the options to the authenticator and wait for a response
                attResp = await startRegistration({ optionsJSON });
            } catch (error) {
                // Some basic error handling
                if (error.name === 'InvalidStateError') {
                    elemError.innerText = 'Error: Authenticator was probably already registered by user';
                } else {
                    elemError.innerText = error;
                }

                throw error;
            }

            // Verify registration
            const completeResp = await fetch('/register/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attResp)
            });
            const completeData = await completeResp.json();

            if (completeResp.status === 200) {
                alert('Registration successful');
            } else {
                alert(completeData.error);
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            if (!username) {
                alert('Please enter a username');
                return;
            }

            // Begin authentication
            const beginResp = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            const beginData = await beginResp.json();

            if (beginResp.status !== 200) {
                alert(beginData.error);
                return;
            }

            // Convert challenge and allowCredentials
            beginData.publicKey.challenge = Uint8Array.from(atob(beginData.publicKey.challenge), c => c.charCodeAt(0));
            beginData.publicKey.allowCredentials = beginData.publicKey.allowCredentials.map(cred => ({
                ...cred,
                id: Uint8Array.from(atob(cred.id), c => c.charCodeAt(0))
            }));

            // Get credential
            const credential = await navigator.credentials.get({ publicKey: beginData.publicKey });

            // Complete authentication
            const completeResp = await fetch('/login/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credential)
            });
            const completeData = await completeResp.json();

            if (completeResp.status === 200) {
                window.location.href = '/emails';
            } else {
                alert(completeData.error);
            }
        }
    </script>
{% endblock %}